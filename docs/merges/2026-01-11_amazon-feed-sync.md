# Merge Report: feature/amazon-feed-sync

**Date:** 2026-01-11
**Merged By:** Claude Code
**Branch:** `feature/amazon-feed-sync` → `main`

---

## Summary

Successfully merged the Amazon Feed Sync feature which provides comprehensive SP-API integration for syncing inventory prices and quantities to Amazon.

---

## Changes Overview

| Metric | Count |
|--------|-------|
| Files Changed | 93 |
| Insertions | +14,642 |
| Deletions | -2,150 |
| New Tables | 4 |
| New API Routes | 12 |

---

## Key Features Added

### Amazon Feed Sync
- **Queue Management**: Add inventory items to a sync queue pending submission to Amazon
- **Price Conflict Detection**: Detects and resolves conflicts between local prices and Amazon/queued prices
- **Feed Submission**: Submits JSON_LISTINGS_FEED to Amazon SP-API
- **Feed Polling**: Monitors feed processing status with automatic polling
- **Price Verification**: Verifies price application for new SKU listings (handles 30min Amazon delay)
- **SKU Detection**: Queries Amazon API directly to detect existing SKUs not in local cache

### Platform Stock Comparison
- Amazon stock comparison view
- Import status tracking

### Reporting Improvements
- Enhanced profit/loss reports
- Removed deprecated tax-summary report
- New profit-loss-detailed endpoint

---

## New Files

### Amazon Sync Core
- `apps/web/src/lib/amazon/amazon-sync.service.ts` - Main sync service (1852 lines)
- `apps/web/src/lib/amazon/amazon-sync.types.ts` - Type definitions (500 lines)
- `apps/web/src/lib/amazon/amazon-feeds.client.ts` - Feeds API client
- `apps/web/src/lib/amazon/amazon-listings.client.ts` - Listings API client
- `apps/web/src/lib/amazon/amazon-catalog.client.ts` - Catalog API client
- `apps/web/src/lib/amazon/amazon-sync.config.ts` - Variation config for debugging

### API Routes
- `/api/amazon/sync/queue` - Queue management
- `/api/amazon/sync/queue/[id]` - Single queue item
- `/api/amazon/sync/submit` - Submit feed
- `/api/amazon/sync/feeds` - Feed history
- `/api/amazon/sync/feeds/[id]` - Feed details
- `/api/amazon/sync/feeds/[id]/poll` - Poll feed status
- `/api/amazon/sync/feeds/[id]/verify` - Verify prices
- `/api/amazon/sync/verify` - Manual verification
- `/api/platform-stock/*` - Platform stock comparison

### UI Components
- `SyncQueueTable` - Queue display with actions
- `SyncFeedHistoryTable` - Feed history list
- `SyncFeedDetailDialog` - Feed details with items
- `PriceConflictDialog` - Conflict resolution UI
- `SyncSubmitControls` - Submit/dry-run buttons
- `AddToSyncButton` - Inventory table action

### Database Migrations
- `20260115000001_amazon_feed_sync.sql` - Core tables
- `20260111074100_amazon_feed_price_verification.sql` - Verification columns
- `20260116000001_amazon_product_cache.sql` - Product type caching
- `20260116000002_amazon_sync_queue_is_new_sku.sql` - New SKU flag

---

## Database Schema

### New Tables

| Table | Purpose |
|-------|---------|
| `amazon_sync_queue` | Items pending sync to Amazon |
| `amazon_sync_feeds` | Feed submission tracking |
| `amazon_sync_feed_items` | Per-ASIN results within feeds |
| `amazon_product_cache` | Product type cache (6-month TTL) |

All tables have:
- ✅ RLS enabled with user-based policies
- ✅ Proper indexes on foreign keys
- ✅ `updated_at` triggers
- ✅ CHECK constraints for status enums

---

## Verification Results

| Check | Result |
|-------|--------|
| TypeScript | ✅ Passed |
| ESLint | ✅ Passed |
| Post-merge verification | ✅ Passed |

---

## Known Issues / Future Work

1. **Hardcoded marketplace ID** - UK marketplace ID is hardcoded in some places instead of using the constant
2. **Sequential bulk processing** - `addBulkToQueue` processes items sequentially; could be parallelized
3. **Extensive console logging** - Consider using a proper logger with log levels

---

## Commits

| Hash | Message |
|------|---------|
| ac853bc | feat: Add Amazon Feed Sync feature |
| f43dc3b | Merge branch 'feature/amazon-feed-sync' |

---

## Recovery Instructions

If rollback is needed:

```powershell
# Revert the merge commit
git revert -m 1 f43dc3b
git push origin main

# Or hard reset (destructive, before others pull)
git reset --hard e2615b7
git push origin main --force
```

---

*Generated by Merge Feature Agent*
